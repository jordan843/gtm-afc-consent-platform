___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "AfC - Consent Management Platform",
  "brand": {
    "id": "brand_ads_for_change",
    "displayName": "Ads for Change",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "GDPR-compliant consent banner with full Google Consent Mode v2 support, IAB TCF 2.2 compatibility, region-specific defaults, and consent restoration from cookies.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "cmpId",
    "displayName": "Identifiant CMP",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Votre identifiant CMP unique fourni par la plateforme Ads for Change CMP Manager."
  },
  {
    "type": "TEXT",
    "name": "apiUrl",
    "displayName": "URL de l\u0027API",
    "simpleValueType": true,
    "defaultValue": "https://nzkzahxktzncvosefdul.supabase.co/functions/v1",
    "help": "URL de base de l\u0027API CMP (ne pas modifier sauf instruction contraire)"
  },
  {
    "type": "GROUP",
    "name": "regionSettings",
    "displayName": "Configuration par région (GDPR)",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "enableRegionSpecific",
        "checkboxText": "Activer les paramètres spécifiques par région",
        "simpleValueType": true,
        "defaultValue": true,
        "help": "Applique des règles de consentement différentes selon la région (EEA, UK, etc.)"
      },
      {
        "type": "TEXT",
        "name": "gdprRegions",
        "displayName": "Régions GDPR (codes ISO séparés par virgules)",
        "simpleValueType": true,
        "defaultValue": "AT,BE,BG,HR,CY,CZ,DK,EE,FI,FR,DE,GR,HU,IE,IT,LV,LT,LU,MT,NL,PL,PT,RO,SK,SI,ES,SE,GB,NO,IS,LI,CH",
        "help": "Liste des codes pays ISO où le consentement GDPR est requis",
        "enablingConditions": [
          {
            "paramName": "enableRegionSpecific",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentDefaults",
    "displayName": "Paramètres de consentement par défaut",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "defaultAnalytics",
        "displayName": "Analytics par défaut",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Refusé"
          },
          {
            "value": "granted",
            "displayValue": "Accordé"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "defaultAds",
        "displayName": "Publicité par défaut",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Refusé"
          },
          {
            "value": "granted",
            "displayValue": "Accordé"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "defaultFunctional",
        "displayName": "Fonctionnel par défaut",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Refusé"
          },
          {
            "value": "granted",
            "displayValue": "Accordé"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "granted"
      },
      {
        "type": "CHECKBOX",
        "name": "enableUrlPassthrough",
        "checkboxText": "Activer URL passthrough",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "enableAdsDataRedaction",
        "checkboxText": "Activer la rédaction des données publicitaires",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "TEXT",
        "name": "waitForUpdate",
        "displayName": "Délai d\u0027attente mise à jour (ms)",
        "simpleValueType": true,
        "defaultValue": "500"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "iabSettings",
    "displayName": "Paramètres IAB TCF 2.2",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "enableIAB",
        "checkboxText": "Activer le support IAB TCF 2.2",
        "simpleValueType": true,
        "defaultValue": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "advancedSettings",
    "displayName": "Paramètres avancés",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "cookieDomain",
        "displayName": "Domaine du cookie",
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "type": "TEXT",
        "name": "cookieExpiry",
        "displayName": "Durée de validité du cookie (jours)",
        "simpleValueType": true,
        "defaultValue": "365"
      },
      {
        "type": "CHECKBOX",
        "name": "debugMode",
        "checkboxText": "Activer le mode debug",
        "simpleValueType": true,
        "defaultValue": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const createQueue = require('createQueue');
const gtagSet = require('gtagSet');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const getType = require('getType');
const getCookieValues = require('getCookieValues');
const setCookie = require('setCookie');
const localStorage = require('localStorage');
const JSON = require('JSON');
const getTimestampMillis = require('getTimestampMillis');
const encodeUriComponent = require('encodeUriComponent');
const makeNumber = require('makeNumber');
const addEventCallback = require('addEventCallback');
const callInWindow = require('callInWindow');
const copyFromWindow = require('copyFromWindow');

const CMP_ID = data.cmpId;
const API_URL = data.apiUrl;
const STORAGE_KEY = 'cmp_consent';
const COOKIE_NAME = 'cmp_consent';
const DEBUG = data.debugMode || false;
const WAIT_FOR_UPDATE = makeNumber(data.waitForUpdate) || 500;

const debugLog = function(msg, obj) {
  if (DEBUG) { log('[CMP]', msg, obj || ''); }
};

// Parse GDPR regions
const gdprRegionsList = data.gdprRegions ? data.gdprRegions.split(',') : [];
const gdprRegions = [];
for (var i = 0; i < gdprRegionsList.length; i++) {
  var region = gdprRegionsList[i];
  if (region) { gdprRegions.push(region.trim().toLowerCase()); }
}

// Set default consent state with region support for GDPR countries
if (data.enableRegionSpecific && gdprRegions.length > 0) {
  setDefaultConsentState({
    'analytics_storage': data.defaultAnalytics || 'denied',
    'ad_storage': data.defaultAds || 'denied',
    'ad_user_data': data.defaultAds || 'denied',
    'ad_personalization': data.defaultAds || 'denied',
    'functionality_storage': data.defaultFunctional || 'denied',
    'personalization_storage': 'granted',
    'security_storage': 'granted',
    'wait_for_update': WAIT_FOR_UPDATE,
    'region': gdprRegions
  });
  
  // Permissive defaults for non-GDPR regions
  setDefaultConsentState({
    'analytics_storage': 'granted',
    'ad_storage': 'granted',
    'ad_user_data': 'granted',
    'ad_personalization': 'granted',
    'functionality_storage': 'granted',
    'personalization_storage': 'granted',
    'security_storage': 'granted'
  });
} else {
  setDefaultConsentState({
    'analytics_storage': data.defaultAnalytics || 'denied',
    'ad_storage': data.defaultAds || 'denied',
    'ad_user_data': data.defaultAds || 'denied',
    'ad_personalization': data.defaultAds || 'denied',
    'functionality_storage': data.defaultFunctional || 'denied',
    'personalization_storage': 'denied',
    'security_storage': 'granted',
    'wait_for_update': WAIT_FOR_UPDATE
  });
}

// Set gtag configuration
if (data.enableUrlPassthrough) { gtagSet('url_passthrough', true); }
if (data.enableAdsDataRedaction) { gtagSet('ads_data_redaction', true); }
gtagSet('developer_id.dZGVmYW', true);

// Function to update consent state from consent data
const doUpdateConsent = function(analyticsConsent, marketingConsent, functionalConsent) {
  debugLog('Updating consent state:', {
    analytics: analyticsConsent,
    marketing: marketingConsent,
    functional: functionalConsent
  });
  
  updateConsentState({
    'analytics_storage': analyticsConsent ? 'granted' : 'denied',
    'ad_storage': marketingConsent ? 'granted' : 'denied',
    'ad_user_data': marketingConsent ? 'granted' : 'denied',
    'ad_personalization': marketingConsent ? 'granted' : 'denied',
    'functionality_storage': functionalConsent ? 'granted' : 'denied',
    'security_storage': functionalConsent ? 'granted' : 'denied',
    'personalization_storage': functionalConsent ? 'granted' : 'denied'
  });
  
  debugLog('Consent state updated successfully');
};

// Function to update consent from stored object
const updateFromStoredConsent = function(consent) {
  doUpdateConsent(consent.analytics, consent.marketing, consent.functional);
  
  const dataLayerPush = createQueue('dataLayer');
  dataLayerPush({
    'event': 'cmp_consent_restored',
    'consent_type': consent.consent_type || 'stored',
    'consent_analytics': consent.analytics,
    'consent_marketing': consent.marketing,
    'consent_functional': consent.functional,
    'cmp_id': CMP_ID
  });
  
  if (data.enableIAB) {
    dataLayerPush({
      'event': 'cmp_tcf_update',
      'tcf_consent_all': consent.consent_type === 'accept_all'
    });
  }
};

// Listen for ALL events and filter for cmp_consent_update
addEventCallback(function(containerId, eventData) {
  // Only process cmp_consent_update events
  if (!eventData || eventData.event !== 'cmp_consent_update') { return; }
  
  debugLog('Received cmp_consent_update event', eventData);
  
  // Get consent values from the event data
  var analyticsConsent = eventData.analytics_consent || eventData.consent_analytics || false;
  var marketingConsent = eventData.marketing_consent || eventData.consent_marketing || false;
  var functionalConsent = eventData.functional_consent || eventData.consent_functional || false;
  
  // Update consent state using GTM native API
  doUpdateConsent(analyticsConsent, marketingConsent, functionalConsent);
  
  // Push confirmation event
  const dataLayerPush = createQueue('dataLayer');
  dataLayerPush({
    'event': 'cmp_consent_applied',
    'consent_analytics': analyticsConsent,
    'consent_marketing': marketingConsent,
    'consent_functional': functionalConsent,
    'cmp_id': CMP_ID
  });
});

// Safe JSON parse function (GTM doesn't support try/catch)
const safeParseJSON = function(str) {
  if (!str || getType(str) !== 'string') { return null; }
  // Check if string looks like valid JSON object
  var trimmed = str.trim ? str.trim() : str;
  if (trimmed.indexOf('{') !== 0) { return null; }
  var parsed = JSON.parse(str);
  if (parsed && getType(parsed) === 'object') { return parsed; }
  return null;
};

// Check for existing consent in cookie
const cookieConsent = getCookieValues(COOKIE_NAME);
if (cookieConsent && cookieConsent.length > 0) {
  var cookieStr = cookieConsent[0];
  if (cookieStr && getType(cookieStr) === 'string') {
    var consent = safeParseJSON(cookieStr);
    if (consent && consent.cmpId === CMP_ID) {
      updateFromStoredConsent(consent);
      data.gtmOnSuccess();
      return;
    }
  }
}

// Check localStorage
const existingConsentStr = localStorage.getItem(STORAGE_KEY);
if (existingConsentStr && getType(existingConsentStr) === 'string') {
  var storedConsent = safeParseJSON(existingConsentStr);
  if (storedConsent) {
    updateFromStoredConsent(storedConsent);
    data.gtmOnSuccess();
    return;
  }
}

// Load CMP widget
setInWindow('__CMP_CONFIG__', {
  id: CMP_ID,
  apiUrl: API_URL,
  storageKey: STORAGE_KEY,
  cookieName: COOKIE_NAME,
  cookieDomain: data.cookieDomain || 'auto',
  cookieExpiry: makeNumber(data.cookieExpiry) || 365,
  enableIAB: data.enableIAB || false,
  debug: DEBUG
}, true);

const scriptUrl = API_URL + '/cmp-loader/index.ts?id=' + encodeUriComponent(CMP_ID) + '&t=' + getTimestampMillis();
injectScript(scriptUrl, data.gtmOnSuccess, data.gtmOnFailure, 'cmpScript');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.supabase.co/*"
              },
              {
                "type": 1,
                "string": "https://nzkzahxktzncvosefdul.supabase.co/*"
              }
            ]
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__CMP_CONFIG__"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__tcfapi"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "event"
              },
              {
                "type": 1,
                "string": "consent.*"
              },
              {
                "type": 1,
                "string": "cmp.*"
              },
              {
                "type": 1,
                "string": "tcf.*"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "developer_id.dZGVmYW"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "cmp_consent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "cmp_consent"
              },
              {
                "type": 1,
                "string": "cmp_consent_*"
              },
              {
                "type": 1,
                "string": "_ga"
              },
              {
                "type": 1,
                "string": "_gid"
              },
              {
                "type": 1,
                "string": "_gcl_*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "cmp_consent"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "/"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Quick Test
  code: runCode();
setup: ''


___NOTES___

CMP - Consent Management Platform by Ads for Change
https://adsforchange.co

Fonctionnalités:
- Google Consent Mode v2 complet
- Support régions GDPR (EEA, UK, CH, NO, IS, LI)
- IAB TCF 2.2 compatible
- Lecture cookies de consentement
- gtagSet pour url_passthrough et ads_data_redaction
- setDefaultConsentState avec région
- updateConsentState natif GTM


